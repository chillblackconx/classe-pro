<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Classe-Pro — Tâches</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg-1: #07101a;
    --bg-2: #08121b;
    --card: rgba(255,255,255,0.03);
    --glass: rgba(255,255,255,0.04);
    --accent: #00e6c3;
    --accent2: #6ff0ff;
    --muted: #9fb0b6;
    --danger: #ff6b6b;
    --radius: 14px;
    --neon: 0 6px 30px rgba(0,230,195,0.08);
    font-family: Inter, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; min-height:100vh;
    background: radial-gradient(1000px 500px at 10% 10%, rgba(0,120,255,0.06), transparent),
                linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color:#e6fbf6;
    display:flex; flex-direction:column; align-items:center; padding:18px;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  header{width:100%; max-width:1200px; display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px}
  .brand{display:flex; gap:12px; align-items:center}
  .logo{
    width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:800;
    background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#022b29; box-shadow: var(--neon);
  }
  h1{margin:0; font-size:20px}
  .sub{color:var(--muted); font-size:13px}

  .top-controls{display:flex; gap:10px; align-items:center}
  .btn{
    padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent;
    color:var(--accent); cursor:pointer; font-weight:700; letter-spacing:0.2px;
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .btn:hover{transform:translateY(-3px); box-shadow:0 10px 30px rgba(0,0,0,0.5)}
  .btn.ghost{color:#cfeee6}
  .btn.danger{background:linear-gradient(90deg,var(--danger),#ff8a8a); color:#fff; border:none}
  .small{font-size:13px; padding:6px 10px}

  main{width:100%; max-width:1200px; display:grid; grid-template-columns: 1fr 380px; gap:18px; align-items:start}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.03)}
  .board{padding:12px}

  .controls-row{display:flex; gap:8px; align-items:center; margin-bottom:10px}
  select,input[type=text],input[type=number],textarea{background:transparent; border:1px solid rgba(255,255,255,0.04); color:inherit; padding:8px; border-radius:8px}
  .flex{display:flex; gap:8px; align-items:center}
  .grow{flex:1}

  .grid{overflow:auto; max-height:62vh; border-radius:10px; padding:6px; margin-top:6px}
  table{border-collapse:collapse; width:100%; min-width:700px}
  th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.03); text-align:left}
  th{position:sticky; top:0; background:linear-gradient(180deg, rgba(0,0,0,0.25), transparent); font-size:13px}
  td.name-col{width:260px; font-weight:700}
  td.task-col{text-align:center; width:100px}
  input[type=checkbox]{width:18px;height:18px; cursor:pointer}

  .muted{color:var(--muted); font-size:13px}
  .progressBar{height:10px; background:rgba(255,255,255,0.04); border-radius:999px; overflow:hidden}
  .progressFill{height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); width:0%}

  /* message area big */
  .message-display{min-height:80px; display:flex; align-items:center; justify-content:center; border-radius:10px; padding:12px; font-size:20px; text-align:center; background: linear-gradient(90deg, rgba(0,230,195,0.04), rgba(122,241,255,0.02)); color:var(--accent)}
  textarea{width:100%; resize:vertical}

  /* timer */
  .timer-large{font-size:28px; font-weight:800; text-align:center; margin:8px 0}

  /* save toast */
  .save-toast{
    position:fixed; right:24px; bottom:24px; background:linear-gradient(90deg, rgba(0,230,195,0.08), rgba(122,241,255,0.03));
    border:1px solid rgba(255,255,255,0.06); padding:12px 16px; border-radius:12px; color:var(--accent);
    display:flex; gap:10px; align-items:center; box-shadow:0 8px 40px rgba(0,0,0,0.6); transform: translateY(30px); opacity:0;
  }
  .save-toast.show{animation: toastIn .44s forwards}
  @keyframes toastIn{ to { transform:translateY(0); opacity:1 } }

  /* small utilities */
  .row{display:flex; gap:8px; align-items:center}
  .tiny{font-size:12px}
  footer{margin-top:18px; color:var(--muted); font-size:13px}

  @media (max-width:980px){
    main{grid-template-columns: 1fr}
    table{min-width:640px}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">CP</div>
    <div>
      <h1>Classe-Pro — Tâches</h1>
      <div class="sub">Interface locale · sauvegarde stylée · thème 2049.space</div>
    </div>
  </div>

  <div class="top-controls">
    <button class="btn ghost small" id="exportBtn">Exporter</button>
    <button class="btn ghost small" id="importBtn">Importer</button>
    <button class="btn small" id="clearAllBtn">Effacer tout</button>
  </div>
</header>

<main>
  <!-- Left: board -->
  <section class="card board">
    <div class="controls-row">
      <select id="classSelect" class="small"></select>
      <input id="newClassName" type="text" placeholder="Nouvelle classe..." class="small" />
      <button class="btn small" id="createClassBtn">Créer</button>
      <button class="btn small" id="renameClassBtn">Renommer</button>
      <button class="btn small danger" id="deleteClassBtn">Supprimer</button>
    </div>

    <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center">
      <input id="studentNameInput" class="grow" type="text" placeholder="Ajouter élève (nom)">
      <button class="btn" id="addStudentBtn">Ajouter élève</button>
      <input id="taskNameInput" type="text" placeholder="Nouvelle tâche (ex: Lecture)" style="width:160px">
      <button class="btn" id="addTaskBtn">Ajouter tâche</button>
      <button class="btn ghost" id="removeTaskBtn">Suppr. dernière</button>
    </div>

    <div class="grid" id="gridContainer">
      <table id="classTable"></table>
    </div>

    <div style="display:flex; gap:12px; align-items:center; margin-top:10px;">
      <div style="flex:1">
        <div class="muted">Progress global</div>
        <div class="progressBar" style="margin-top:8px"><div class="progressFill" id="globalProgress"></div></div>
      </div>
      <div id="globalPercent" class="muted" style="width:60px; text-align:right">0%</div>
    </div>
  </section>

  <!-- Right: tools -->
  <aside style="display:flex; flex-direction:column; gap:12px">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>Message du jour</strong>
        <div class="muted tiny">Visible en grand</div>
      </div>
      <div id="displayMessage" class="message-display" style="margin-top:8px">Tapez un message...</div>
      <textarea id="messageInput" placeholder="Écrire un message..."></textarea>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
        <button class="btn" id="saveMsgBtn">Mettre à jour</button>
        <button class="btn ghost" id="clearMsgBtn">Effacer</button>
      </div>
    </div>

    <div class="card">
      <strong>Chronomètre</strong>
      <div id="stopwatch" class="timer-large">00:00:00</div>
      <div style="display:flex; gap:8px; justify-content:center">
        <button class="btn" id="swStart">Start</button>
        <button class="btn ghost" id="swStop">Stop</button>
        <button class="btn" id="swReset">Reset</button>
      </div>
    </div>

    <div class="card">
      <strong>Minuteur</strong>
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <input id="timerMin" type="number" min="0" placeholder="min" style="width:80px">
        <input id="timerSec" type="number" min="0" max="59" placeholder="sec" style="width:80px">
        <button class="btn" id="startTimerBtn">Démarrer</button>
        <button class="btn ghost" id="stopTimerBtn">Arrêter</button>
      </div>
      <div id="countdown" class="timer-large" style="margin-top:10px">00:00</div>
    </div>

    <div class="card">
      <strong>Importer / Exporter</strong>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="fileInput" type="file" accept="application/json" style="flex:1">
      </div>
      <div class="muted tiny" style="margin-top:8px">Exporter pour sauvegarde externe, importer pour restaurer.</div>
    </div>
  </aside>
</main>

<div class="save-toast" id="saveToast">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" style="filter:drop-shadow(0 6px 18px rgba(0,0,0,0.5))">
    <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <div><strong id="saveToastText">Tâches sauvegardées</strong><div class="muted tiny" id="saveToastTime">Maintenant</div></div>
</div>

<footer style="width:100%; max-width:1200px; text-align:center; margin-top:18px" class="muted tiny">
  Classe-Pro — thème futuriste · sauvegarde locale
</footer>

<script>
/* =========================
   STATE & STORAGE
   ========================= */
const STORAGE_KEY = 'classepro_tasks_v2';
let state = {
  classes: {}, // className: { students: [{name, tasks:[]}, ...], tasks: [taskName,...], message: '' }
  currentClass: null,
  stopwatch: { elapsed:0, running:false }, // not persisted frame-accurate but store basic
  timer: { remaining:0 }
};

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) state = JSON.parse(raw);
  } catch(e) { console.error('load', e) }
  if(!state.currentClass || !state.classes[state.currentClass]) {
    const defaultName = Object.keys(state.classes)[0] || 'Classe 1';
    if(!state.classes[defaultName]) state.classes[defaultName] = { students: [], tasks: [], message: 'Bienvenue sur Classe-Pro' };
    state.currentClass = defaultName;
    saveState(true);
  }
}
function saveState(silent=false){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    showSaveToast(silent ? 'Sauvegarde auto' : 'Tâches sauvegardées');
  } catch(e){ console.error('save', e) }
}

/* =========================
   TOAST / SAVE FEEDBACK
   ========================= */
const saveToast = document.getElementById('saveToast');
const saveToastText = document.getElementById('saveToastText');
const saveToastTime = document.getElementById('saveToastTime');
let toastTimer = null;
function showSaveToast(text = 'Tâches sauvegardées'){
  saveToastText.textContent = text;
  const t = new Date();
  saveToastTime.textContent = t.toLocaleTimeString();
  saveToast.classList.remove('show'); // reset
  void saveToast.offsetWidth;
  saveToast.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> saveToast.classList.remove('show'), 2200);
}

/* =========================
   UI ELEMENTS
   ========================= */
const classSelect = document.getElementById('classSelect');
const classTable = document.getElementById('classTable');
const studentNameInput = document.getElementById('studentNameInput');
const taskNameInput = document.getElementById('taskNameInput');
const globalProgress = document.getElementById('globalProgress');
const globalPercent = document.getElementById('globalPercent');
const messageInput = document.getElementById('messageInput');
const displayMessage = document.getElementById('displayMessage');
const fileInput = document.getElementById('fileInput');

/* =========================
   RENDER / HELPERS
   ========================= */
function refreshClassSelect(){
  classSelect.innerHTML = '';
  Object.keys(state.classes).forEach(name => {
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
    classSelect.appendChild(opt);
  });
  classSelect.value = state.currentClass;
}

function renderTable(){
  const cls = state.classes[state.currentClass];
  if(!cls) return;
  classTable.innerHTML = '';

  // header
  const thead = document.createElement('thead');
  const htr = document.createElement('tr');
  const thName = document.createElement('th'); thName.textContent = 'Élèves'; htr.appendChild(thName);
  cls.tasks.forEach((t, idx) => {
    const th = document.createElement('th');
    th.innerHTML = `${escapeHtml(t)}<div class="muted tiny" style="margin-top:6px">${countCheckedForTask(idx)}/${cls.students.length}</div>`;
    htr.appendChild(th);
  });
  const thAct = document.createElement('th'); thAct.textContent = 'Actions'; htr.appendChild(thAct);
  thead.appendChild(htr);
  classTable.appendChild(thead);

  // body
  const tbody = document.createElement('tbody');
  cls.students.forEach((s, i) => {
    const tr = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.className='name-col';
    tdName.innerHTML = `<div>${escapeHtml(s.name)}</div><div class="muted tiny">${completedCount(s)} / ${cls.tasks.length} complété</div>`;
    tr.appendChild(tdName);

    cls.tasks.forEach((t,j) => {
      const td = document.createElement('td'); td.className='task-col';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!s.tasks[j];
      cb.addEventListener('change', ()=> {
        s.tasks[j] = cb.checked;
        saveState(true);
        renderTable();
      });
      td.appendChild(cb);
      tr.appendChild(td);
    });

    const tdAct = document.createElement('td');
    const delBtn = document.createElement('button'); delBtn.className='btn ghost small'; delBtn.textContent='Suppr';
    delBtn.addEventListener('click', ()=> {
      if(confirm(`Supprimer élève "${s.name}" ?`)){
        cls.students.splice(i,1);
        renderTable(); saveState();
      }
    });
    tdAct.appendChild(delBtn);
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });

  classTable.appendChild(tbody);
  updateProgress();
}

function completedCount(student){
  return (student.tasks || []).reduce((a,b)=> a + (b?1:0), 0);
}
function countCheckedForTask(idx){
  const cls = state.classes[state.currentClass];
  return cls.students.reduce((acc,s)=> acc + (s.tasks[idx] ? 1 : 0), 0);
}
function updateProgress(){
  const cls = state.classes[state.currentClass];
  if(!cls) return;
  const total = cls.students.length * Math.max(1, cls.tasks.length);
  const checked = cls.students.reduce((acc,s)=> acc + (s.tasks ? s.tasks.filter(Boolean).length : 0), 0);
  const pct = total === 0 ? 0 : Math.round((checked/total)*100);
  globalProgress.style.width = pct + '%';
  globalPercent.textContent = pct + '%';
}

/* =========================
   ACTIONS: classes / students / tasks
   ========================= */
document.getElementById('createClassBtn').addEventListener('click', ()=>{
  const name = document.getElementById('newClassName').value.trim() || prompt('Nom classe ?','Classe');
  if(!name) return;
  if(state.classes[name]) return alert('Nom déjà existant');
  state.classes[name] = { students: [], tasks: [], message: 'Tapez votre message ici' };
  state.currentClass = name;
  document.getElementById('newClassName').value = '';
  refreshClassSelect(); renderTable(); renderMessage(); saveState();
});

document.getElementById('renameClassBtn').addEventListener('click', ()=>{
  const old = state.currentClass;
  const name = prompt('Nouveau nom pour la classe', old);
  if(!name || name === old) return;
  if(state.classes[name]) return alert('Nom déjà utilisé');
  state.classes[name] = state.classes[old];
  delete state.classes[old];
  state.currentClass = name;
  refreshClassSelect(); renderTable(); saveState();
});

document.getElementById('deleteClassBtn').addEventListener('click', ()=>{
  const c = state.currentClass;
  if(!confirm(`Supprimer la classe "${c}" (toutes les données seront perdues) ?`)) return;
  delete state.classes[c];
  const names = Object.keys(state.classes);
  state.currentClass = names[0] || null;
  if(!state.currentClass){
    state.classes['Classe 1'] = { students: [], tasks: [], message:'Bienvenue' };
    state.currentClass = 'Classe 1';
  }
  refreshClassSelect(); renderTable(); saveState();
});

classSelect.addEventListener('change', ()=>{
  state.currentClass = classSelect.value;
  renderTable(); renderMessage(); saveState(true);
});

document.getElementById('addStudentBtn').addEventListener('click', ()=>{
  const name = studentNameInput.value.trim();
  if(!name) return alert('Donne un nom');
  const cls = state.classes[state.currentClass];
  const student = { name, tasks: Array(cls.tasks.length).fill(false) };
  cls.students.push(student);
  studentNameInput.value = '';
  renderTable(); saveState();
});

document.getElementById('addTaskBtn').addEventListener('click', ()=>{
  const name = taskNameInput.value.trim() || prompt('Nom de la tâche?','Tâche');
  if(!name) return;
  const cls = state.classes[state.currentClass];
  cls.tasks.push(name);
  cls.students.forEach(s => s.tasks.push(false));
  taskNameInput.value = '';
  renderTable(); saveState();
});

document.getElementById('removeTaskBtn').addEventListener('click', ()=>{
  const cls = state.classes[state.currentClass];
  if(cls.tasks.length === 0) return;
  if(!confirm(`Supprimer la dernière tâche "${cls.tasks[cls.tasks.length-1]}" ?`)) return;
  cls.tasks.pop();
  cls.students.forEach(s => s.tasks.pop());
  renderTable(); saveState();
});

/* =========================
   MESSAGE BOARD
   ========================= */
document.getElementById('saveMsgBtn').addEventListener('click', ()=> {
  const cls = state.classes[state.currentClass];
  cls.message = messageInput.value;
  renderMessage(); saveState();
});
document.getElementById('clearMsgBtn').addEventListener('click', ()=> {
  const cls = state.classes[state.currentClass];
  cls.message = ''; messageInput.value = '';
  renderMessage(); saveState();
});
function renderMessage(){
  const cls = state.classes[state.currentClass];
  displayMessage.textContent = cls.message || 'Tapez un message...';
  messageInput.value = cls.message || '';
}

/* =========================
   EXPORT / IMPORT / CLEAR
   ========================= */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'classepro-export.json'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

document.getElementById('importBtn').addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || !obj.classes) return alert('Fichier invalide');
      if(confirm('Remplacer l\'état actuel par le fichier importé ?')) {
        state = obj;
        if(!state.currentClass || !state.classes[state.currentClass]) state.currentClass = Object.keys(state.classes)[0] || null;
        refreshClassSelect(); renderTable(); renderMessage(); saveState();
      }
    }catch(err){ alert('Fichier JSON invalide'); }
  };
  reader.readAsText(f);
});

document.getElementById('clearAllBtn').addEventListener('click', ()=>{
  if(!confirm('Effacer toutes les données locales (localStorage) ?')) return;
  localStorage.removeItem(STORAGE_KEY);
  state = { classes: { 'Classe 1': { students: [], tasks: [], message: 'Bienvenue' } }, currentClass: 'Classe 1' };
  refreshClassSelect(); renderTable(); renderMessage(); saveState();
});

/* =========================
   STOPWATCH (chronomètre)
   ========================= */
let swInterval = null, swStartTime = 0, swElapsed = 0;
const swDisplay = document.getElementById('stopwatch');
function formatHMS(ms){
  const s = Math.floor(ms/1000);
  const hh = Math.floor(s/3600), mm = Math.floor((s%3600)/60), ss = s%60;
  return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
document.getElementById('swStart').addEventListener('click', ()=>{
  if(swInterval) return;
  swStartTime = Date.now() - swElapsed;
  swInterval = setInterval(()=> {
    swElapsed = Date.now() - swStartTime;
    swDisplay.textContent = formatHMS(swElapsed);
  }, 200);
});
document.getElementById('swStop').addEventListener('click', ()=>{
  if(swInterval) { clearInterval(swInterval); swInterval = null; saveState(true); }
});
document.getElementById('swReset').addEventListener('click', ()=>{
  swElapsed = 0; swStartTime = 0;
  if(swInterval){ clearInterval(swInterval); swInterval = null; }
  swDisplay.textContent = '00:00:00';
  saveState(true);
});

/* =========================
   TIMER (minuteur)
   ========================= */
let timerInterval = null, timerEnd = 0;
const countdown = document.getElementById('countdown');
function formatMS(ms){
  const total = Math.max(0, Math.ceil(ms/1000));
  const mm = Math.floor(total/60), ss = total%60;
  return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
document.getElementById('startTimerBtn').addEventListener('click', ()=>{
  const m = parseInt(document.getElementById('timerMin').value) || 0;
  const s = parseInt(document.getElementById('timerSec').value) || 0;
  let ms = (m*60 + s)*1000;
  if(ms <= 0) return alert('Entrer une durée > 0');
  if(timerInterval) clearInterval(timerInterval);
  timerEnd = Date.now() + ms;
  timerInterval = setInterval(()=> {
    const rem = timerEnd - Date.now();
    if(rem <= 0){ clearInterval(timerInterval); timerInterval = null; countdown.textContent = '00:00'; alert('Temps écoulé !'); saveState(true); return; }
    countdown.textContent = formatMS(rem);
  }, 200);
});
document.getElementById('stopTimerBtn').addEventListener('click', ()=>{
  if(timerInterval){ clearInterval(timerInterval); timerInterval = null; saveState(true); }
});

/* =========================
   UTILITIES
   ========================= */
function escapeHtml(str){ return String(str || '').replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* =========================
   INIT
   ========================= */
loadState();
refreshClassSelect();
renderMessage();
renderTable();

/* autosave every 6s (stylée toast) */
setInterval(()=> saveState(true), 6000);

/* also save when window/tab hidden */
document.addEventListener('visibilitychange', ()=> {
  if(document.hidden) saveState(true);
});

/* keyboard: Enter to add student quickly when focused */
studentNameInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('addStudentBtn').click(); } });
taskNameInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('addTaskBtn').click(); } });

/* small helper to set initial default class if none existed */
if(!Object.keys(state.classes).length){
  state.classes['Classe 1'] = { students: [], tasks: [], message: 'Bienvenue' };
  state.currentClass = 'Classe 1';
  saveState(true);
}

/* helper to render message on load */
function renderMessage(){ const cls = state.classes[state.currentClass]; displayMessage.textContent = cls.message || 'Tapez un message...'; messageInput.value = cls.message || ''; }

/* file import: reset input value after use */
fileInput.addEventListener('change', ()=> setTimeout(()=> { fileInput.value = ''; }, 300));
</script>
</body>
</html>
